<template>
  <div>
    <div class="p-8">
      <div v-if="error">
        <h1 class="mt-4 mb-2">error</h1>
        <div class="font-mono text-red text-xl">{{error}}</div>
      </div>
      <div class="flex flex-col md:flex-row">
        <div>
          <h1 class="mt-4 mb-2">health check</h1>
          <div class="my-1" v-for="(value, key) in health" :key="key">
            {{key}}:
            <ae-loader v-if="value === null"></ae-loader>
            <ae-icon name="check" v-if="value === true"></ae-icon>
            <span v-if="value === false" class="text-red font-bold">HEALTHCHECK FAILED</span>
          </div>
        </div>
        <div class="md:ml-8 md:pl-8 md:border-l">
          <h1 class="mt-4 mb-2">ts to block</h1>
          <div>
            <div class="flex flex-row">
              <div class="flex flex-col mb-4">
                <label for="date" class="font-mono">Date</label>
                <input class="input" id="date" v-model="date" type="date"/>
              </div>

              <div class="flex flex-col mb-4">
                <label for="time" class="font-mono">Time</label>
                <input class="input" id="time" v-model="time" type="time"/>
              </div>

              <div class="flex flex-col mb-4">
                <label for="zone" class="font-mono">Timezone</label>
                <input class="input" id="zone" v-model="timezone" type="number"
                       placeholder="+ 0"/>
              </div>
            </div>

            <div class="flex flex-col mb-4">
              <label class="font-mono">Result Block</label>
              <div class="text-xl font-mono">{{block}}</div>
            </div>
          </div>
        </div>
      </div>

      <h1 class="mt-4 mb-2">current height</h1>
      <bigger-loader v-if="!height"/>
      <div class="font-mono text-xl" v-else>{{height}}</div>

      <h1 class="mt-4 mb-2">slots</h1>
      <bigger-loader v-if="loading"/>
      <div v-if="!loading">
        <div class="flex-row p-2 border-t border-grey-light hidden md:flex">
          <div class="flex-1">Slot Id</div>
          <div class="flex-1">Time Capacity</div>
          <div class="flex-1">Bid Time Bounds</div>
          <div class="flex-1">Block Height Bounds</div>
          <div class="flex-1">Successful Bids</div>
          <div class="flex-1">Failed Bids</div>
        </div>
        <div v-for="slot in slots" :key="slot.id">
          <div class="flex flex-col p-2 border-t border-grey-light md:flex-row">
            <div class="flex-1">
              <div class="font-bold block md:hidden mt-3 mb-1">Slot</div>
              {{slot.id}}
              <ae-badge v-if="slot.timing.active" class="active-badge">active</ae-badge>
              <ae-badge v-if="slot.timing.past">past</ae-badge>
              <ae-badge v-if="slot.timing.future">future</ae-badge>
              <br>
              <ae-button v-if="slot.timing.past" face="round" fill="primary">
                <a :href="slot.downloadLink">
                  export
                  <ae-icon name="save"/>
                </a>
              </ae-button>
            </div>
            <div class="flex-1">
              <div class="font-bold block md:hidden mt-3 mb-1">Time Capacity</div>
              {{slot.capacityUsed}} min used of {{slot.timeCapacity}} min
            </div>
            <div class="flex-1">
              <div class="font-bold block md:hidden mt-3 mb-1">Bid Time Bounds</div>
              Minimum Time: {{slot.minimumTimePerBid}} min<br>
              Maximum Time: {{slot.maximumTimePerBid}} min
            </div>
            <div class="flex-1">
              <div class="font-bold block md:hidden mt-3 mb-1">Block Height Bounds</div>
              Start height {{slot.startBlockHeight}}<br>
              est.
              <span>{{blockToDate(slot.startBlockHeight)}}</span>
              <br>
              <br>
              End height&nbsp;&nbsp;{{slot.endBlockHeight}}<br>
              est.
              <span>{{blockToDate(slot.endBlockHeight)}}</span>
            </div>
            <div class="flex-1">
              <div class="font-bold block md:hidden mt-3 mb-1">Successful Bids</div>
              Count: {{slot.success.bids.length}}<br>
              Σ Amount: {{slot.success.amountSum.toFixed()}} AE<br>
              Σ Time: {{slot.success.timeSum}} min
              <div v-if="slot.success.bids.length">
                Min: {{Math.min(...slot.success.amountPerTime)}} AE/min<br>
                Max: {{Math.max(...slot.success.amountPerTime)}} AE/min
              </div>
              <ae-button v-if="slot.success.bids.length" face="round" fill="primary"
                         @click="showBids(slot.id, 'successful', slot.success.bids)">
                inspect
                <ae-icon name="eye"/>
              </ae-button>
            </div>
            <div class="flex-1">
              <div class="font-bold block md:hidden mt-3 mb-1">Failed Bids</div>
              Count: {{slot.failed.bids.length}}<br>
              Σ Amount: {{slot.failed.amountSum.toFixed()}} AE<br>
              Σ Time: {{slot.failed.timeSum}} min
              <div v-if="slot.failed.bids.length">
                Min: {{Math.min(...slot.failed.amountPerTime)}} AE/min<br>
                Max: {{Math.max(...slot.failed.amountPerTime)}} AE/min
              </div>
              <ae-button v-if="slot.failed.bids.length" face="round" fill="primary"
                         @click="showBids(slot.id, 'failed', slot.failed.bids)">
                inspect
                <ae-icon name="eye"/>
              </ae-button>
            </div>
          </div>
        </div>
      </div>

      <bigger-loader v-if="inspectBidsLoading"/>
      <div v-if="inspectBids">
        <h2>{{inspectBids.state}} bids Slot {{inspectBids.slotId}}</h2><br>
        <div class="flex-row p-2 border-t border-grey-light hidden md:flex">
          <div class="flex-1">Data</div>
          <div class="flex-1">Preview</div>
        </div>
        <div v-for="bid in inspectBids.bids" :key="bid.seqId">
          <div class="flex flex-col md:flex-row p-2 border-t border-grey-light">
            <div class="flex-1">
              Sequence: {{bid.seqId}}<br>
              Amount: {{bid.amountAe.toFixed()}} AE<br>
              Time: {{bid.time}} min<br>
              Amount/Time: {{bid.amountPerTimeAe}} AE/min<br>
              Bidder: {{bid.user}}<br>
              X:{{bid.data.coordinates.x}} Y:{{bid.data.coordinates.y}}
            </div>
            <div class="flex-1">
              <img :src='bid.url' v-if="bid.url" class="w-full preview-image" alt="Bidding Image">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
  import {EpochChain, EpochContract} from '@aeternity/aepp-sdk'
  import Util from '@/utils/blockchain_util'
  import {AeBadge, AeButton, AeIcon, AeLoader} from '@aeternity/aepp-components'
  import BiggerLoader from '@/components/BiggerLoader'
  import BigNumber from 'bignumber.js'
  import config from '@/config'
  import axios from 'axios'
  import bugsnagClient from '@/utils/bugsnag'

  export default {
    name: 'Admin',
    components: {AeLoader, BiggerLoader, AeBadge, AeButton, AeIcon},
    data() {
      return {
        slots: [],
        height: 0,
        avgBlockTime: 3 * 60,
        loading: true,
        interval: null,
        inspectBidsLoading: false,
        inspectBids: null,
        date: null,
        time: null,
        timezone: null,
        resultBlock: null,
        health: {
          ipfsNode: null,
          blockchainNode: null,
          teaserFiles: null,
          teaserContract: null,
          testFiles: null,
          testContract: null
        },
        error: null
      }
    },
    computed: {
      blockchainSettings() {
        return config.blockchainSettings
      },
      apiURL() {
        return config.apiUrl
      },
      timeZoneString() {
        if (!this.timezone || this.timezone === 0) return '';
        return this.timezone > 0 ? 'GMT +' + this.timezone : 'GMT ' + this.timezone
      },
      block() {
        const target = Date.parse(`${this.date || ' '} ${this.time || ' '} ${this.timeZoneString || ' '}`);
        const current = Date.now();
        const diff = target - current;
        const goalBlock = parseInt(this.height + diff / 180000);
        return Number.isNaN(goalBlock) ? 0 : goalBlock;
      }
    },
    methods: {
      blockToDate(goalBlock) {
        const diff = goalBlock - this.height;
        return new Date(diff * 180000 + Date.now()).toLocaleString([],
          {
            day: '2-digit',
            month: '2-digit',
            year: '2-digit',
            hour: '2-digit',
            minute:'2-digit',
            timeZoneName: 'short'
          });
      },
      runHealthChecks() {
        this.health = {
          ipfsNode: null,
          blockchainNode: null,
          teaserFiles: null,
          teaserContract: null,
          testFiles: null,
          testContract: null
        };
        axios.get(`${this.apiURL}/health/ipfsNode`).then(() => this.health.ipfsNode = true).catch(() => {
          this.health.ipfsNode = false
        })
        axios.get(`${this.apiURL}/health/blockchainNode`).then(() => this.health.blockchainNode = true).catch(() => this.health.blockchainNode = false)
        axios.get(`${this.apiURL}/health/teaserFiles`).then(() => this.health.teaserFiles = true).catch(() => this.health.teaserFiles = false)
        axios.get(`${this.apiURL}/health/teaserContract`).then(() => this.health.teaserContract = true).catch(() => this.health.teaserContract = false)
        axios.get(`${this.apiURL}/health/testFiles`).then(() => this.health.testFiles = true).catch(() => this.health.testFiles = false)
        axios.get(`${this.apiURL}/health/testContract`).then(() => this.health.testContract = true).catch(() => this.health.testContract = false)
      },
      async loadData() {
        try {
          const client = await EpochChain.compose(EpochContract)({
            url: `https://testnet.dronegraffiti.com`,
            internalUrl: `https://testnet.dronegraffiti.com`,
          })

          this.height = await client.height()

          const called = await client.contractEpochCall(this.blockchainSettings.contractAddress, 'sophia-address', 'all_auction_slots', '()', '')
          const decoded = await client.contractEpochDecodeData(Util.auctionSlotListType, called.out)
          this.slots = Util.auctionSlotListToObject(decoded)
            .sort((a, b) => a.endBlockHeight - b.endBlockHeight)
            .map(slot => {
              return {
                id: slot.id,
                downloadLink: `${config.apiUrl}/slots/${slot.id}`,
                timing: {
                  past: Util.slotIsPast(slot, this.height),
                  active: Util.slotIsActive(slot, this.height),
                  future: Util.slotIsFuture(slot, this.height)
                },
                timeCapacity: slot.timeCapacity,
                minimumTimePerBid: slot.minimumTimePerBid,
                maximumTimePerBid: slot.maximumTimePerBid,
                startBlockHeight: slot.startBlockHeight,
                endBlockHeight: slot.endBlockHeight,
                capacityUsed: Util.slotCapacityUsed(slot),
                success: {
                  bids: slot.successfulBids.sort((a, b) => a.seqId - b.seqId),
                  amountSum: Util.atomsToAe(slot.successfulBids.reduce((acc, x) => acc.plus(x.amount), new BigNumber(0))),
                  timeSum: slot.successfulBids.reduce((acc, x) => Number(x.time) + acc, 0),
                  amountPerTime: slot.successfulBids.map(x => x.amountPerTime).map(x => Util.atomsToAe(x).toFixed(4))
                },
                failed: {
                  bids: slot.failedBids.sort((a, b) => a.seqId - b.seqId),
                  amountSum: Util.atomsToAe(slot.failedBids.reduce((acc, x) => acc.plus(x.amount), new BigNumber(0))),
                  timeSum: slot.failedBids.reduce((acc, x) => Number(x.time) + acc, 0),
                  amountPerTime: slot.failedBids.map(x => x.amountPerTime).map(x => Util.atomsToAe(x).toFixed(4))
                },

              }
            })
          this.loading = false
        } catch (e) {
          bugsnagClient.notify(e)
          this.error = e.message
        }
      },
      async showBids(slotId, state, bids) {
        this.inspectBidsLoading = true
        this.inspectBids = null
        bids = bids.map(bid => {
          bid.url = config.apiUrl + '/ipfs/' + bid.data.artworkReference + '.svg'
          bid.amountAe = Util.atomsToAe(bid.amount)
          bid.amountPerTimeAe = Util.atomsToAe(bid.amountPerTime).toFixed(4)
          return bid
        })
        this.inspectBidsLoading = false
        this.inspectBids = {slotId: slotId, state: state, bids: bids}
      }
    },
    created() {
      this.runHealthChecks()
      this.loadData()
      this.interval = setInterval(() => {
        this.loadData()
        this.runHealthChecks()
      }, 30000)
    },
    beforeDestroy() {
      clearInterval(this.interval)
    }
  }
</script>

<style lang="scss" scoped>
  @import "~@aeternity/aepp-components/src/styles/variables/colors.scss";

  a {
    color: $color-neutral-maximum;
    text-decoration: none;
  }

  .active-badge {
    background-color: $color-primary;
  }

  .ae-button {
    transform-origin: top left;
    transform: scale(0.7);
  }

  .preview-image {
    max-height: 300px;
  }

  .input {
    height: 50px;
    display: block;
    @apply border-b p-2 font-mono text-xl max-w-xs;
  }
</style>
