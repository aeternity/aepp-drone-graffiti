<template>
  <div>
    <WhiteHeader title="Auction Slots" :back="back">
      <h2>Slots</h2>
      <p class="p-4 pb-0">
        The bidding slots are fixed length auctions. While a slot is open, meaning the maximum block
        height is not reached, you may add your bid. Once the maximum block height is reached by the network the smart
        contract will take all top bids and send them to the drones to paint.
      </p>
    </WhiteHeader>


    <div class="w-full p-8 pb-6">
      <div class="flex justify-center flex-col">
        <h1 class="text-center mb-2">Drawtime Auctions</h1>
        <span class="text-xl text-center leading-normal text-grey-darker">
          Bid in an auction for your artwork to be sprayed on the wall
        </span>
      </div>
    </div>

    <div class="w-full p-8 flex justify-center items-center" v-if="isLoadingState">
      <div>
        <BiggerLoader></BiggerLoader>
      </div>
    </div>

    <div v-if="isEmptyListState" class="w-full">
      <swiper :options="swiperOption" ref="mySwiper" @slideChange="slideChange">
        <swiper-slide class="ae-max-width">
          <div class="mt-2 mb-2">
            <ae-card>
              <div class="flex flex-col relative w-full">
                <div>
                  <h2 class="text-black">Currently no open Auction Slots</h2>
                </div>
                <ae-divider></ae-divider>
                <div v-if="nextSlotAtHeight" class="flex flex-col text-black text-base mt-2">
                  <span>
                    Next Auction Slot opens in
                  </span>
                  <span class="font-mono text-black text-xl">
                    <Countdown :initialTime="(nextSlotAtHeight - height) * 180"></Countdown>
                  </span>
                </div>
                <div v-else class="flex flex-col text-black text-base mt-2">
                   <span>
                    no more Auction Slots planned
                  </span>
                </div>
              </div>
            </ae-card>
          </div>
        </swiper-slide>
      </swiper>
    </div>

    <div v-if="isShowListState" class="w-full">

      <swiper :options="swiperOption" ref="mySwiper" @slideChange="slideChange">
        <swiper-slide v-for="slot in slots" :key="slot.id" class="ae-max-width">
          <div class="mt-2 mb-2">
            <ae-card>
              <div class="flex flex-col relative w-full">
                <div>
                  <h2 class="text-black">Slot {{slot.id}} ({{slot.successful_bids.length + slot.failed_bids.length}}
                    Bids)</h2>
                </div>
                <div class="flex flex-col text-black text-base mt-2">
                <span>
                  Slot will be open for estimated
                </span>
                  <span class="font-mono text-black text-xl">
                  <Countdown :initialTime="(slot.end_block_height - height) * 180"></Countdown>
                </span>
                </div>

                <ae-divider></ae-divider>
                <div class="flex flex-col text-black text-base mt-2">
                <span>
                 current minimum bid AE / Minute
                </span>

                  <span class="font-mono text-black text-xl" v-if="slot.successful_bids.length === 0">
                    0 AE (No Bids)
                  </span>
                  <span class="font-mono text-black text-xl" v-else>
                    {{slot.minimumBid.toFixed(5)}} AE
                  </span>
                  <span v-if="slot.remainingDrawtime > 0" class="font-sans text-grey-darker text-base">{{slot.remainingDrawtime}} unclaimed Minutes</span>
                </div>


                <div v-if="slot.artworkToBig || slot.artworkToSmall">
                  <ae-divider></ae-divider>
                  <div class="flex flex-col mt-2">
                <span class="font-mono text-red text-lg" v-if="slot.artworkToBig">
                  Your artwork takes to much Dronetime for this slot. Consider making it smaller.
                </span>
                    <span class="font-mono text-red text-lg" v-if="slot.artworkToSmall">
                  Your artwork takes to less Dronetime for this slot. Consider making it larger.
                </span>
                  </div>
                </div>
              </div>
            </ae-card>
          </div>
        </swiper-slide>
      </swiper>
      <div class="w-full mt-6 mb-8 flex justify-center">
        <transition>
          <ae-button class="ae-max-width" face="round" fill="primary" @click="next" extend v-if="!nextButtonDisabled">
            Bid in this slot
          </ae-button>
          <ae-button class="ae-max-width" face="round" fill="neutral" extend disabled v-if="nextButtonDisabled">
            CAN NOT BID ON THIS SLOT
          </ae-button>
        </transition>
      </div>
    </div>
  </div>
</template>

<script>
  import Aepp from '@aeternity/aepp-sdk/es/ae/aepp'
  import Util from '~/utils/blockchain_util'
  import BiggerLoader from '~/components/BiggerLoader'
  import Countdown from '~/components/Countdown'
  import { AeButton, AeCard, AeDivider } from '@aeternity/aepp-components'
  import WhiteHeader from '~/components/WhiteHeader'
  import 'swiper/dist/css/swiper.css'
  import config from '~/config'
  import contractSource from '~/assets/GraffitiAuction.aes'

  import { swiper, swiperSlide } from 'vue-awesome-swiper'

  const SHOW_LIST = 1, EMPTY_LIST = 2, LOADING = 3

  export default {
    name: 'Slots',
    components: { AeDivider, WhiteHeader, AeButton, AeCard, Countdown, BiggerLoader, swiper, swiperSlide },
    data () {
      return {
        state: LOADING,
        bids: [],
        slots: [],
        client: null,
        height: 0,
        nextSlotAtHeight: null,
        choice: null,
        swiperOption: {
          slidesPerView: 'auto',
          spaceBetween: 35,
          centeredSlides: true
        },
      }
    },
    computed: {
      isLoadingState () {
        return this.state === LOADING
      },
      isShowListState () {
        return this.state === SHOW_LIST
      },
      isEmptyListState () {
        return this.state === EMPTY_LIST
      },
      blockchainSettings () {
        return config.blockchainSettings
      },
      transformedImage () {
        return this.$store.state.transformedImage
      },
      nextButtonDisabled () {
        let slot = this.slots.find(slot => slot.id === this.choice)
        return !this.choice
          || !this.slots
          || !slot
          || slot.artworkToBig
          || slot.artworkToSmall
          || !Util.slotIsActive(slot, this.height)
      }
    },
    methods: {
      slideChange () {
        const realIndex = this.$refs.mySwiper.swiper.realIndex
        this.choice = this.slots.find(slot => slot.index === realIndex).id
      },
      async updateMyBids () {
        //TODO change to contractInstances

        const contractInstance = await this.client.getContractInstance(contractSource, {contractAddress: this.blockchainSettings.contractAddress})
        const allBids = await contractInstance.methods.all_auction_slots()

        let slotIndex = 0

        const nextSlots = allBids.decodedResult
          .filter(slot => Util.slotIsFuture(slot, this.height))
          .sort((a, b) => a.start_block_height - b.start_block_height)

        if (nextSlots.length) this.nextSlotAtHeight = nextSlots[0].start_block_height

        this.slots = allBids.decodedResult
          .filter(slot => Util.slotIsActive(slot, this.height))
          .map(slot => {
            slot.index = slotIndex++
            slot.minimumBid = Math.min.apply(Math, slot.successful_bids.map(function (bid) {
              return bid.amount_per_time
            }))
            slot.minimumBid = slot.successful_bids.length === 0 ? 0 : Util.atomsToAe(slot.minimumBid)
            slot.remainingDrawtime = Util.slotCapacityRemaining(slot)
            slot.artworkToBig = slot.maximum_time_per_bid < this.transformedImage.dronetime
            slot.artworkToSmall = slot.minimum_time_per_bid > this.transformedImage.dronetime
            return slot
          })

        if (this.slots.length > 0) this.state = SHOW_LIST
        else return this.state = EMPTY_LIST

        this.choice = this.slots[0].id
      },
      next () {
        this.$store.dispatch('updateBidding', {
          slotId: this.choice,
          slotObject: this.slots.find(slot => slot.id === this.choice)
        })
        this.$router.push('amount')
      },
      back () {
        this.$router.push('positioning')
      }
    },
    created () {
      Aepp().then(async ae => {
        this.client = ae
        this.height = await this.client.height()
        await this.updateMyBids()
      })
    }
  }
</script>

<style scoped lang="scss">
  .ae-max-width {
    width: 75%;
    max-width: 75%;
  }
</style>
