<template>
  <div>

    <InfoLayer>
      <h2>Rendering</h2>
      <p class="p-4 pb-0">
        The rendering step shows a SVG version of the image you uploaded in the previous step. Below the preview there
        are several options to adapt the SVG to your liking.
      </p>
      <p class="p-4 pb-0">
        <!-- TODO Describe what the options do-->
      </p>
    </InfoLayer>
    <WhiteHeader title="Your Drone Art" :back="back"></WhiteHeader>
    <div v-show="isLoading">
      <BiggerLoader></BiggerLoader>
    </div>
    <div class="w-full p-8">
      <div v-show="isReady">
        <div class="w-full ae-image-preview flex justify-center items-center">
          <img ref="previewImage" :src="transformedImage.src" alt="Rendered Image"/>
        </div>
      </div>
    </div>
    <ae-backdrop class="p-6" v-show="backDropVisible" @click.native.self="showBackdrop">
      <ae-card>
        <div class="w-full">
          <div class="text-center">
            <h3 class="text-black p-4">Edit Art</h3>
          </div>

          <div class="flex flex-row mb-4">
            <ae-switch
              class="w-full"
              @input="updateValue"
              name="example"
              :choices="[
                    { label: 'Photo', value: 'photo' },
                    { label: 'Illustration', value: 'illustration' },
                  ]"
              :default="this.centerline ? 'illustration' : 'photo'"
            ></ae-switch>
          </div>
          <div>
            <div class="flex flex-row justify-around items-center mb-6 mt-2">
              <template v-for="(color, index) in droneSettings.colors">
                <div :key="color" @click="changeColor(index)" class="w-full flex justify-center">
                  <div v-if="currentColor === index" :style="{backgroundColor: color}"
                       class="h-8 w-8 rounded-full shadow-lg text-white">
                    <div class="w-full h-full flex justify-center items-center">
                      <ae-icon name="check" class="text-white"></ae-icon>
                    </div>
                  </div>
                  <div v-else :style="{backgroundColor: color}" class="h-8 w-8 rounded-full"></div>
                </div>
              </template>
            </div>
          </div>
          <div>
          </div>
          <div v-if="showIllustration">
            <div class="mb-4">
              <div class="flex w-full justify-between text-black mb-2">
                <label for="binaryThreshold">Color threshold</label><span>{{binaryThreshold}}</span>
              </div>
              <div class="w-full">
                <input id="binaryThreshold" class="w-full max-w-full" type="range" step="1" min="0" max="100" v-model="binaryThreshold"/>
              </div>
            </div>
            <div class="mb-4">
              <div class="flex w-full justify-between text-black mb-2">
                <label for="dilationRadius">Stroke weight</label><span>{{dilationRadius}}</span>
              </div>
              <div class="w-full">
                <input id="dilationRadius" class="w-full max-w-full" type="range" step="1" min="1" max="20" v-model="dilationRadius"/>
              </div>
            </div>
          </div>
          <div v-else>
            <div class="mb-4">
              <div class="flex w-full justify-between text-black mb-2">
                <label for="blurKernel">Blur Radius</label><span>{{blurKernel}}</span>
              </div>
              <div class="w-full">
                <input id="blurKernel" class="w-full max-w-full" type="range" step="1" min="1" max="10" v-model="blurKernel"/>
              </div>
            </div>
            <div class="mb-4">
              <div class="flex w-full justify-between text-black mb-2">
                <label for="hysteresisHighThreshold">Threshold</label><span>{{hysteresisHighThreshold}}</span>
              </div>
              <div class="w-full">
                <input id="hysteresisHighThreshold" class="w-full max-w-full" type="range" step="1" min="1" max="100"
                       v-model="hysteresisHighThreshold"/>
              </div>
            </div>
          </div>

          <ae-button face="round" fill="primary" @click="closeBackdropAndUpdatePreview" extend>
            Update Preview
          </ae-button>
        </div>
      </ae-card>
    </ae-backdrop>

    <div class="w-full absolute pin-b mb-6">
      <ae-button-group class="mr-4 ml-4">
        <ae-button face="round" fill="secondary" @click="showBackdrop">
          Edit Art
        </ae-button>
        <ae-button face="round" fill="primary" @click="submit">
          Place Art
        </ae-button>
      </ae-button-group>
    </div>
  </div>
</template>

<script>

  import InfoLayer from '@/components/InfoLayer'
  import BiggerLoader from '../components/BiggerLoader'
  import WhiteHeader from '@/components/WhiteHeader'
  import { AeSwitch, AeIcon, AeButtonGroup, AeBackdrop, AeCard, AeButton } from '@aeternity/aepp-components'

  const STATUS_LOADING = 1, STATUS_READY = 2

  export default {
    name: 'Render',
    components: {
      AeIcon,
      AeButtonGroup,
      AeBackdrop,
      AeCard,
      AeButton,
      WhiteHeader,
      BiggerLoader,
      InfoLayer,
      AeSwitch
    },
    data () {
      return {
        hysteresisHighThreshold: 50,
        currentColor: 0,
        centerline: true,
        blurKernel: 4,
        binaryThreshold: 45,
        dilationRadius: 4,
        status: STATUS_LOADING,
        progress: -1,
        backDropVisible: false
      }
    },
    computed: {
      isChanged () {
        return Number(this.threshold) !== this.settings.threshold ||
          Number(this.currentColor) !== this.settings.color ||
          Number(this.hysteresisHighThreshold) !== this.settings.hysteresisHighThreshold ||
          Number(this.centerline) !== this.settings.centerline ||
          Number(this.blurKernel) !== this.settings.blurKernel ||
          Number(this.binaryThreshold) !== this.settings.binaryThreshold ||
          Number(this.dilationRadius) !== this.settings.dilationRadius
      },
      transformedImage () {
        return this.$store.state.transformedImage
      },
      originalImage () {
        return this.$store.state.originalImage
      },
      settings () {
        return this.$store.state.settings
      },
      droneSettings () {
        return this.$store.state.droneSettings
      },
      showIllustration () {
        return this.centerline
      },
      isLoading () {
        return this.status === STATUS_LOADING
      },
      isReady () {
        return this.status === STATUS_READY
      }
    },
    methods: {
      back () {
        this.$router.push('contribute')
      },
      submit () {
        this.$router.push('positioning')
      },
      updateValue (val) {
        this.centerline = (val !== 'photo')
      },
      showBackdrop () {
        this.backDropVisible = !this.backDropVisible
      },
      closeBackdropAndUpdatePreview() {
        this.backDropVisible = false;
        this.$nextTick(() => this.updatePreview())
      },
      async updatePreview () {
        this.status = STATUS_LOADING
        console.log('loading')
        await this.$store.dispatch(`updateSettings`, {
          color: Number(this.currentColor),
          threshold: Number(this.threshold),
          hysteresisHighThreshold: Number(this.hysteresisHighThreshold),
          centerline: Number(this.centerline),
          blurKernel: Number(this.blurKernel),
          binaryThreshold: Number(this.binaryThreshold),
          dilationRadius: Number(this.dilationRadius)
        })
        this.status = STATUS_READY
      },
      changeColor (index) {
        this.currentColor = index
      },
      progressCallback (progress) {
        const progress100 = Math.round(progress * 100)
        if (this.progress !== progress100) {
          console.log('UPDATING', progress100)
        }
      }
    },
    created () {
      this.threshold = this.settings.threshold
      this.currentColor = this.settings.color
      this.hysteresisHighThreshold = this.settings.hysteresisHighThreshold
      this.centerline = this.settings.centerline
      this.blurKernel = this.settings.blurKernel
      this.binaryThreshold = this.settings.binaryThreshold
      this.dilationRadius = this.settings.dilationRadius
      this.$store.dispatch('registerProgressCallback', this.progressCallback)
    },
    async mounted () {
      await this.$store.dispatch(`transformImage`)
      this.status = STATUS_READY
    },
    beforeDestroy () {
      this.$store.dispatch('removeProgressCallback')
    }
  }
</script>

<style scoped>
  .ae-image-preview {
    max-height: 60vh;
  }

  .ae-image-preview img {
    max-height: inherit;
    width: auto;
    height: auto;
  }
</style>
